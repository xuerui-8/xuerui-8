CloudStack SAML 登录测试工具
**
1. 工具简介
本工具用于测试 CloudStack 云平台的 SAML 单点登录（SSO）功能，通过动态生成符合 SAML 2.0 协议的响应数据，批量尝试指定用户名的登录操作，并记录登录结果（成功 / 失败）及会话 ID（Session ID），适用于合法授权的云平台身份验证功能测试场景。
2. 核心功能
动态生成 SAML 2.0 响应：自动填充当前 UTC 时间（IssueInstant）和有效期（NotOnOrAfter，当前时间 + 1 小时），支持自定义用户名；
Base64 编码：SAML 响应数据自动进行 Base64 编码，符合 SSO 协议传输要求；
批量登录尝试：支持对多个用户名批量发起登录请求；
结果记录与输出：实时打印登录结果到控制台，同时将详细日志写入 exploit.log 文件（含时间戳）；
会话 ID 提取：登录成功时自动从响应中提取 Session ID，便于后续测试操作。
3. 环境依赖
3.1 运行环境
Python 3.6+（推荐 3.8+）
3.2 依赖库
工具依赖以下第三方 Python 库，需提前安装：
requests：发送 HTTP POST 请求，与 CloudStack API 交互；
beautifulsoup4：解析 HTML/XML 响应，提取 Session ID。
3.3 安装命令
在终端执行以下命令安装依赖库：
pip install requests beautifulsoup4

4. 使用步骤
4.1 配置修改
打开工具脚本，根据目标 CloudStack 环境修改以下核心参数：
参数名
说明
修改示例
url
目标 CloudStack 的 SAML 登录 API 地址
http://192.168.1.100:8080/client/api
saml:Issuer
SAML 响应的签发者（需与目标平台配置一致）
http://your-saml-idp.com
用户名列表
需测试的用户名（支持邮箱格式，符合 SAML emailAddress 格式要求）
["test@domain.com", "admin@domain.com"]

4.2 运行工具
在终端切换到脚本所在目录，执行以下命令启动测试：
python cloudstack_saml_test.py

4.3 结果查看
控制台输出：实时显示每个用户名的登录结果（成功 / 失败原因、Session ID（若成功）、HTTP 状态码）；
日志文件：所有操作记录（含时间戳）会自动写入当前目录的 exploit.log 文件，格式如下：
2025-08-27 15:30:00,123 - Login successful, session ID: 5f8d2a7b9c3e10
2025-08-27 15:30:02,456 - Login failed, no session ID found

5. 关键逻辑说明
5.1 SAML 响应生成流程
时间生成：获取当前 UTC 时间，格式化为 SAML 协议要求的 YYYY-MM-DDTHH:MM:SSZ 格式；
模板填充：将用户名、时间、目标 URL、签发者等信息填入 SAML 2.0 响应模板；
Base64 编码：对填充后的 SAML 响应字符串进行 UTF-8 编码，再通过 Base64 编码，确保符合 HTTP 传输要求。
5.2 登录请求与结果判断
请求发送：以 POST 方式向 CloudStack API 发送请求，参数包含 command=samlSsoLogin（CloudStack 固定 SAML 登录命令）和 SAMLResponse（Base64 编码后的 SAML 响应）；
结果判断：
若 HTTP 状态码为 200，解析响应内容，查找 <sessionid> 标签，存在则登录成功，否则登录失败；
若 HTTP 状态码非 200（如 400、403、500），直接判定登录失败并记录状态码。
6. 注意事项
合法授权：本工具仅用于 已获得明确授权 的 CloudStack 平台测试，未经授权使用可能违反《网络安全法》及相关法律法规，使用者需自行承担法律责任；
SAML 配置一致性：工具中的 saml:Issuer、NameID Format 等参数需与目标 CloudStack 平台的 SAML 身份提供商（IdP）配置一致，否则会导致登录请求被拒绝；
时间同步：SAML 响应中的 IssueInstant 和 NotOnOrAfter 依赖 UTC 时间，若本地时间与目标服务器时间偏差过大（超过 5 分钟），可能触发时间有效性校验失败，建议提前同步系统时间；
日志管理：exploit.log 文件会追加记录，长期使用需定期清理，避免占用过多磁盘空间。
7. 常见问题排查
问题现象
可能原因
排查建议
所有请求返回 “status code: 403”
1. SAML 签发者（Issuer）配置错误；2. 目标平台拒绝该 IP 访问；3. SAML 响应格式非法
1. 核对 saml:Issuer 与 CloudStack 配置；2. 检查目标平台防火墙规则；3. 打印 Base64 解码后的 SAML 响应，验证格式是否符合 XML 规范
状态码 200 但 “no session ID found”
1. 用户名不存在；2. SAML 响应缺少必要属性（如角色、权限）；3. 目标平台 SAML 配置未关联用户账号
1. 确认测试用户名在目标平台已存在；2. 检查 SAML 响应模板是否包含目标平台所需的属性（如 saml:Attribute）；3. 联系目标平台管理员验证 SAML 配置
依赖库导入错误（如 No module named 'bs4'）
未安装 beautifulsoup4 库
执行 pip install beautifulsoup4 重新安装

